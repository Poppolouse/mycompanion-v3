import React, { useState, useEffect, useRef } from 'react';
import { useNavigate } from 'react-router-dom';
import GameSelectionScreen from '../../../components/GameSelectionScreen';
import './Session.css';

/**
 * Session - Aktif oyun session yönetim sayfası
 * Modern tasarım ile oyun deneyimini takip etme merkezi
 */
function Session() {
  const navigate = useNavigate();
  const fileInputRef = useRef(null);
  const videoInputRef = useRef(null);
  const audioRef = useRef(null);

  // Session State
  const [isSessionActive, setIsSessionActive] = useState(false);
  const [sessionTime, setSessionTime] = useState(0);
  const [isPaused, setIsPaused] = useState(false);
  const [currentView, setCurrentView] = useState('session'); // 'session' or 'history'
  const [sessionStartTime, setSessionStartTime] = useState(null);
  const [showGameSelection, setShowGameSelection] = useState(false); // Oyun seçme ekranını göster
  const [currentGame, setCurrentGame] = useState(null); // Başlangıçta aktif oyun yok

  // Media State
  const [screenshots, setScreenshots] = useState([]);
  const [videos, setVideos] = useState([]);
  const [notes, setNotes] = useState('');
  const [currentMood, setCurrentMood] = useState('😊');
  const [sessionRating, setSessionRating] = useState(0);

  // Performance State
  const [performanceData, setPerformanceData] = useState({
    fps: 60,
    cpuUsage: 45,
    gpuUsage: 78,
    ramUsage: 12.5
  });

  // Performance Chart State
  const [performanceTimeRange, setPerformanceTimeRange] = useState('15m'); // '15m', '1h', 'session'
  
  // Time Period State for Statistics
  const [selectedTimePeriod, setSelectedTimePeriod] = useState('1 Hafta');
  
  // 🎯 ACCORDION FİLTRE STATE'LERİ
  const [isFilterExpanded, setIsFilterExpanded] = useState(false);
  const [activeQuickFilters, setActiveQuickFilters] = useState([]);
  const [activeFiltersCount, setActiveFiltersCount] = useState(0);
  
  const [performanceHistory, setPerformanceHistory] = useState({
    '15m': {
      fps: [58, 60, 59, 61, 60, 62, 60],
      cpu: [42, 45, 43, 47, 45, 44, 45],
      gpu: [75, 78, 76, 80, 78, 77, 78],
      ram: [12.2, 12.5, 12.3, 12.7, 12.5, 12.4, 12.5]
    },
    '1h': {
      fps: [59, 60, 58, 61, 60, 59, 62, 60, 61, 59, 60, 60],
      cpu: [43, 45, 44, 46, 45, 43, 47, 45, 44, 43, 45, 45],
      gpu: [76, 78, 77, 79, 78, 76, 80, 78, 79, 77, 78, 78],
      ram: [12.1, 12.5, 12.3, 12.6, 12.5, 12.2, 12.7, 12.5, 12.4, 12.3, 12.5, 12.5]
    },
    'session': {
      fps: [55, 58, 60, 59, 61, 60, 62, 60, 61, 59, 60, 60, 59, 61, 60],
      cpu: [40, 43, 45, 44, 46, 45, 43, 47, 45, 44, 43, 45, 45, 44, 45],
      gpu: [70, 76, 78, 77, 79, 78, 76, 80, 78, 79, 77, 78, 78, 77, 78],
      ram: [11.8, 12.1, 12.5, 12.3, 12.6, 12.5, 12.2, 12.7, 12.5, 12.4, 12.3, 12.5, 12.5, 12.4, 12.5]
    }
  });

  // Audio State
  const [isAudioPlaying, setIsAudioPlaying] = useState(false);
  const [currentTrack, setCurrentTrack] = useState("Epic Gaming Playlist");

  // View Mode State
  const [viewMode, setViewMode] = useState('active'); // 'active' or 'history'
  const [expandedSessions, setExpandedSessions] = useState(new Set());
  const [sortBy, setSortBy] = useState('date');
  const [sortOrder, setSortOrder] = useState('desc');
  const [showFilters, setShowFilters] = useState(false);
  const [filters, setFilters] = useState({
    game: '',
    platform: '',
    dateRange: '',
    duration: '',
    hasMedia: ''
  });

  // Sıralama fonksiyonları
  const handleSort = (field) => {
    if (sortBy === field) {
      setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
    } else {
      setSortBy(field);
      setSortOrder('desc');
    }
  };

  const getSortIcon = (field) => {
    if (sortBy !== field) return '↕️';
    return sortOrder === 'asc' ? '↑' : '↓';
  };

  // Filtre fonksiyonları
  const handleFilterChange = (filterType, value) => {
    setFilters(prev => ({
      ...prev,
      [filterType]: value
    }));
  };

  const resetFilters = () => {
    setFilters({
      game: '',
      platform: '',
      dateRange: '',
      duration: '',
      hasMedia: ''
    });
  };

  const applyFilters = () => {
    setShowFilters(false);
    // Filtre uygulama mantığı burada olacak
  };

  // 🎯 ACCORDION FİLTRE FONKSİYONLARI
  const toggleFilterAccordion = () => {
    setIsFilterExpanded(!isFilterExpanded);
  };

  const handleQuickFilterToggle = (filterValue) => {
    setActiveQuickFilters(prev => {
      const isActive = prev.includes(filterValue);
      if (isActive) {
        return prev.filter(f => f !== filterValue);
      } else {
        return [...prev, filterValue];
      }
    });
  };

  const clearAllFilters = () => {
    setActiveQuickFilters([]);
    setFilters({
      game: '',
      platform: '',
      dateRange: '',
      duration: '',
      hasMedia: ''
    });
  };

  const applyAccordionFilters = () => {
    // Filtre uygulama mantığı
    console.log('Filtreler uygulandı:', { filters, activeQuickFilters });
    setIsFilterExpanded(false);
  };

  // Aktif filtre sayısını hesapla
  useEffect(() => {
    const filterCount = Object.values(filters).filter(value => value !== '').length + activeQuickFilters.length;
    setActiveFiltersCount(filterCount);
  }, [filters, activeQuickFilters]);

  // Timer Effect
  useEffect(() => {
    let interval;
    if (isSessionActive && sessionStartTime) {
      interval = setInterval(() => {
        setSessionTime(Date.now() - sessionStartTime);
      }, 1000);
    }
    return () => clearInterval(interval);
  }, [isSessionActive, sessionStartTime]);

  // Performance Monitoring Effect
  useEffect(() => {
    const performanceInterval = setInterval(() => {
      setPerformanceData({
        fps: Math.floor(Math.random() * 20) + 50,
        cpuUsage: Math.floor(Math.random() * 30) + 30,
        gpuUsage: Math.floor(Math.random() * 40) + 60,
        ramUsage: Math.random() * 5 + 10
      });
    }, 2000);

    return () => clearInterval(performanceInterval);
  }, []);

  // Filters Auto-Collapse Effect
  useEffect(() => {
    const hasActiveFilters = Object.values(filters).some(value => value !== '');
    if (!hasActiveFilters && showFilters) {
      // Eğer hiç filtre seçili değilse ve kart açıksa, kapat
      setShowFilters(false);
    } else if (hasActiveFilters && !showFilters) {
      // Eğer filtre seçiliyse ve kart kapalıysa, aç
      setShowFilters(true);
    }
  }, [filters]);

  // Session Controls
  const startSession = () => {
    setIsSessionActive(true);
    setSessionStartTime(Date.now());
  };

  const pauseSession = () => {
    setIsSessionActive(false);
  };

  const stopSession = () => {
    setIsSessionActive(false);
    setSessionTime(0);
    setSessionStartTime(null);
  };

  // Media Handlers
  const handleScreenshotUpload = (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (event) => {
        setScreenshots(prev => [...prev, {
          id: Date.now() + Math.random(),
          url: event.target.result,
          timestamp: new Date().toLocaleString(),
          name: file.name
        }]);
      };
      reader.readAsDataURL(file);
    });
  };

  const handleVideoUpload = (e) => {
    const files = Array.from(e.target.files);
    files.forEach(file => {
      const reader = new FileReader();
      reader.onload = (event) => {
        setVideos(prev => [...prev, {
          id: Date.now() + Math.random(),
          url: event.target.result,
          timestamp: new Date().toLocaleString(),
          name: file.name,
          size: (file.size / (1024 * 1024)).toFixed(2) + ' MB'
        }]);
      };
      reader.readAsDataURL(file);
    });
  };

  // Audio Controls
  const toggleAudio = () => {
    if (isAudioPlaying) {
      audioRef.current?.pause();
    } else {
      audioRef.current?.play();
    }
    setIsAudioPlaying(!isAudioPlaying);
  };

  const shareSession = () => {
    const sessionData = {
      game: currentGame.title,
      time: formatTime(sessionTime),
      mood: currentMood,
      rating: sessionRating
    };
    console.log('Sharing session:', sessionData);
    // Social sharing logic here
  };

  // Utility Functions
  const formatTime = (ms) => {
    const seconds = Math.floor(ms / 1000);
    const minutes = Math.floor(seconds / 60);
    const hours = Math.floor(minutes / 60);
    return `${hours.toString().padStart(2, '0')}:${(minutes % 60).toString().padStart(2, '0')}:${(seconds % 60).toString().padStart(2, '0')}`;
  };

  const toggleSessionExpansion = (sessionId) => {
    setExpandedSessions(prev => {
      const newSet = new Set(prev);
      if (newSet.has(sessionId)) {
        newSet.delete(sessionId);
      } else {
        newSet.add(sessionId);
      }
      return newSet;
    });
  };

  // Mini Chart Component
  const MiniChart = ({ data, color, max }) => {
    const maxValue = max || Math.max(...data);
    const minValue = Math.min(...data);
    const range = maxValue - minValue || 1;
    
    return (
      <div className="mini-chart">
        <svg width="100%" height="40" viewBox="0 0 100 40">
          <defs>
            <linearGradient id={`gradient-${color}`} x1="0%" y1="0%" x2="0%" y2="100%">
              <stop offset="0%" stopColor={color} stopOpacity="0.8"/>
              <stop offset="100%" stopColor={color} stopOpacity="0.2"/>
            </linearGradient>
          </defs>
          <path
            d={`M 0,${40 - ((data[0] - minValue) / range) * 35} ${data.map((value, index) => 
              `L ${(index / (data.length - 1)) * 100},${40 - ((value - minValue) / range) * 35}`
            ).join(' ')}`}
            fill="none"
            stroke={color}
            strokeWidth="2"
            strokeLinecap="round"
          />
          <path
            d={`M 0,40 L 0,${40 - ((data[0] - minValue) / range) * 35} ${data.map((value, index) => 
              `L ${(index / (data.length - 1)) * 100},${40 - ((value - minValue) / range) * 35}`
            ).join(' ')} L 100,40 Z`}
            fill={`url(#gradient-${color})`}
          />
        </svg>
      </div>
    );
  };

  // Oyun seçme fonksiyonları
  const handleGameSelect = (game) => {
    console.log('Seçilen oyun:', game);
    setCurrentGame({
      title: game.name || game.title,
      platform: game.platforms?.[0]?.platform?.name || game.platform || "PC",
      genre: game.genres?.[0]?.name || game.genre || "Unknown",
      progress: 0,
      coverImage: game.background_image || game.cover || "https://via.placeholder.com/400x600/667eea/ffffff?text=Game+Cover",
      totalPlayTime: "0h 0m"
    });
    setShowGameSelection(false);
    setIsSessionActive(true);
    setSessionStartTime(Date.now());
  };

  const handleCloseGameSelection = () => {
    setShowGameSelection(false);
  };

  // Eğer aktif session yoksa ve oyun seçme ekranı gösterilecekse
  if (!isSessionActive && showGameSelection) {
    return (
      <GameSelectionScreen 
        onGameSelect={handleGameSelect}
        onClose={handleCloseGameSelection}
      />
    );
  }

  return (
    <div className="session-page">
      <div className="session-container">
        {/* Header */}
        <header className="page-header">
          <div className="tracker-header">
            <div className="header-content">
              <div className="header-left">
                <h1>🎯 Gaming Session</h1>
                <p>Aktif oyun deneyiminizi takip edin ve kaydedin</p>
              </div>
              
              <div className="header-controls">
                {/* View Switcher */}
                <div className="view-switcher">
                  <button 
                    className={`view-btn ${viewMode === 'active' ? 'active' : ''}`}
                    onClick={() => {
                      if (!currentGame || !isSessionActive) {
                        setShowGameSelection(true);
                      } else {
                        setViewMode('active');
                      }
                    }}
                  >
                    {(!currentGame || !isSessionActive) ? '🎮 Oyun Seç' : '🎯 Aktif Session'}
                  </button>
                  <button 
                    className={`view-btn ${viewMode === 'history' ? 'active' : ''}`}
                    onClick={() => setViewMode('history')}
                  >
                    📚 Session History
                  </button>
                </div>

                {/* Navigation Buttons */}
                <div className="navigation-buttons">
                  <button 
                    className="nav-btn home-btn"
                    onClick={() => navigate('/')}
                    title="Ana Sayfaya Dön"
                  >
                    🏠 Ana Sayfa
                  </button>
                  <button 
                    className="nav-btn hub-btn"
                    onClick={() => navigate('/game-tracking-hub')}
                    title="Oyun Hub'ına Dön"
                  >
                    🎮 Oyun Hub
                  </button>
                </div>
              </div>
            </div>
          </div>
        </header>

        {/* Ana İçerik */}
        <main className="session-main">
          {/* Active Session View */}
          {viewMode === 'active' && (
            <div>
              {/* Oyun Seçilmemişse */}
              {!currentGame ? (
                <section className="no-game-selected">
                  <div className="no-game-content">
                    <div className="no-game-icon">🎮</div>
                    <h2>Henüz Oyun Seçilmedi</h2>
                    <p>Session başlatmak için önce bir oyun seçin</p>
                    <button 
                      className="select-game-btn"
                      onClick={() => setShowGameSelection(true)}
                    >
                      🎮 Oyun Seç
                    </button>
                  </div>
                </section>
              ) : (
                <>
                  {/* Büyük Game Banner */}
                  <section className="hero-game-banner">
                    <div className="hero-banner-content">
                      {/* Session Status - Banner'ın sağ üstü */}
                      <div className="banner-session-status">
                        <div className={`status-indicator-small ${isSessionActive ? 'active' : 'paused'}`}></div>
                        <span className="status-text">{isSessionActive ? 'Recording' : 'Paused'}</span>
                      </div>
                      
                      <div className="game-cover-large">
                        <img src={currentGame.coverImage} alt={currentGame.title} />
                      </div>
                      <div className="game-info-overlay">
                        <div className="game-details">
                          <h2 className="game-title">{currentGame.title}</h2>
                          <p className="game-meta">{currentGame.platform} • {currentGame.genre}</p>
                          <div className="progress-section">
                            <div className="progress-bar-large">
                              <div 
                                className="progress-fill-large" 
                                style={{ width: `${currentGame.progress}%` }}
                              ></div>
                            </div>
                            <span className="progress-text-large">{currentGame.progress}% Tamamlandı</span>
                          </div>
                        </div>
                      
                        {/* Banner Action Buttons */}
                        <div className="banner-actions">
                          <button className="banner-action-btn start-btn" onClick={startSession}>
                            ▶️ BAŞLAT
                          </button>
                          <button className="banner-action-btn finish-btn" onClick={stopSession}>
                            🏁 BITIR
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
              </section>

              {/* Session Card */}
              <section className="session-card-large">
                <div className="session-card-content">
                  <div className="session-header">
                     <div className="session-title-group">
                       <h3>🎮 Active Gaming Session</h3>
                     </div>
                     <button className="share-btn" onClick={shareSession}>
                       📤 PAYLAŞ
                     </button>
                   </div>
                  
                  {/* Session Timer & Analytics Mini Cards */}
                   <div className="session-mini-cards-grid">
                       <div className={`mini-card timer-mini-card ${isSessionActive ? 'active' : 'paused'}`}>
                         <div className="mini-card-header">
                           <div className="mini-icon">⏱️</div>
                           <button 
                             className={`pause-btn-mini ${isSessionActive ? 'active' : 'paused'}`}
                             onClick={pauseSession}
                           >
                             {isSessionActive ? '⏸️' : '▶️'}
                           </button>
                         </div>
                         <div className="mini-card-content">
                           <h5>Session Time</h5>
                           <div className="timer-display-mini">{formatTime(sessionTime)}</div>
                           <div className={`timer-status-mini ${isSessionActive ? 'recording' : 'paused'}`}>
                             {isSessionActive ? 'Recording...' : 'Paused'}
                           </div>
                           
                           {/* Detaylı İstatistikler */}
                           <div className="timer-stats">
                             <div className="stat-row">
                               <span className="stat-label">🎯 Günlük Hedef:</span>
                               <span className="stat-value">2h 30m</span>
                             </div>
                             <div className="progress-bar">
                               <div className="progress-fill" style={{width: '67%'}}></div>
                             </div>
                             <div className="stat-row">
                               <span className="stat-label">📊 Ortalama Süre:</span>
                               <span className="stat-value">1h 45m</span>
                             </div>
                             <div className="stat-row">
                               <span className="stat-label">🔥 Streak:</span>
                               <span className="stat-value">7 gün</span>
                             </div>
                             <div className="stat-row">
                               <span className="stat-label">⏰ Başlama Saati:</span>
                               <span className="stat-value">19:30</span>
                             </div>
                             <div className="stat-row">
                               <span className="stat-label">🎮 Bu Hafta:</span>
                               <span className="stat-value">12h 15m</span>
                             </div>
                           </div>
                         </div>
                       </div>
                   
                       <div className="mini-card coming-soon-card">
                         <div className="mini-card-header">
                           <div className="mini-icon">🚀</div>
                           <span className="mini-title">Çok Yakında</span>
                         </div>
                         <div className="mini-card-content">
                           <div className="coming-soon-content">
                             <div className="coming-soon-icon">⏳</div>
                             <h6>Yeni Özellikler</h6>
                             <p>Bu bölümde yakında harika yeni özellikler olacak!</p>
                             <div className="feature-list">
                               <div className="feature-item">🎯 Gelişmiş İstatistikler</div>
                               <div className="feature-item">🏆 Başarım Sistemi</div>
                               <div className="feature-item">📊 Detaylı Analitik</div>
                             </div>
                           </div>
                         </div>
                       </div>

                       <div className="mini-card coming-soon-card">
                         <div className="mini-card-header">
                           <div className="mini-icon">🔮</div>
                           <span className="mini-title">Çok Yakında</span>
                         </div>
                         <div className="mini-card-content">
                           <div className="coming-soon-content">
                             <div className="coming-soon-icon">🎮</div>
                             <h6>Oyun Analizi</h6>
                             <p>Oyun performansınızı detaylı analiz edecek araçlar geliyor!</p>
                             <div className="feature-list">
                               <div className="feature-item">📈 Performans Grafikleri</div>
                               <div className="feature-item">🎯 Hedef Takibi</div>
                               <div className="feature-item">🏅 Skor Karşılaştırma</div>
                             </div>
                           </div>
                         </div>
                       </div>
                   </div>

                  {/* Performance Section */}
                  <div className="performance-section">
                    <div className="performance-header">
                      <h3>📊 System Performance</h3>
                      <div className="time-range-selector">
                        <button 
                          className={`time-btn ${performanceTimeRange === '15m' ? 'active' : ''}`}
                          onClick={() => setPerformanceTimeRange('15m')}
                        >
                          15dk
                        </button>
                        <button 
                          className={`time-btn ${performanceTimeRange === '1h' ? 'active' : ''}`}
                          onClick={() => setPerformanceTimeRange('1h')}
                        >
                          1sa
                        </button>
                        <button 
                          className={`time-btn ${performanceTimeRange === 'session' ? 'active' : ''}`}
                          onClick={() => setPerformanceTimeRange('session')}
                        >
                          Session
                        </button>
                      </div>
                    </div>
                    <div className="performance-grid-large">
                      <div className="perf-card-large fps-card">
                        <div className="perf-card-header">
                          <div className="perf-icon">🎮</div>
                          <div className="perf-trend">
                            <span className="trend-indicator positive">↗️ +2</span>
                          </div>
                        </div>
                        <div className="perf-content">
                          <h4>FPS</h4>
                          <div className="perf-value-large">{performanceData.fps}</div>
                          <div className="perf-status">Frames per Second</div>
                          <MiniChart 
                            data={performanceHistory[performanceTimeRange].fps} 
                            color="#22c55e"
                            max={120}
                          />
                        </div>
                      </div>
                      <div className="perf-card-large cpu-card">
                        <div className="perf-card-header">
                          <div className="perf-icon">🔧</div>
                          <div className="perf-trend">
                            <span className="trend-indicator neutral">→ 0</span>
                          </div>
                        </div>
                        <div className="perf-content">
                          <h4>CPU Usage</h4>
                          <div className="perf-value-large">{performanceData.cpuUsage}%</div>
                          <div className="perf-status">Processor Load</div>
                          <MiniChart 
                            data={performanceHistory[performanceTimeRange].cpu} 
                            color="#3b82f6"
                            max={100}
                          />
                        </div>
                      </div>
                      <div className="perf-card-large gpu-card">
                        <div className="perf-card-header">
                          <div className="perf-icon">🎨</div>
                          <div className="perf-trend">
                            <span className="trend-indicator negative">↘️ -3</span>
                          </div>
                        </div>
                        <div className="perf-content">
                          <h4>GPU Usage</h4>
                          <div className="perf-value-large">{performanceData.gpuUsage}%</div>
                          <div className="perf-status">Graphics Load</div>
                          <MiniChart 
                            data={performanceHistory[performanceTimeRange].gpu} 
                            color="#8b5cf6"
                            max={100}
                          />
                        </div>
                      </div>
                      <div className="perf-card-large ram-card">
                        <div className="perf-card-header">
                          <div className="perf-icon">💾</div>
                          <div className="perf-trend">
                            <span className="trend-indicator positive">↗️ +0.2</span>
                          </div>
                        </div>
                        <div className="perf-content">
                          <h4>RAM Usage</h4>
                          <div className="perf-value-large">{performanceData.ramUsage.toFixed(1)}GB</div>
                          <div className="perf-status">Memory Usage</div>
                          <MiniChart 
                            data={performanceHistory[performanceTimeRange].ram} 
                            color="#f59e0b"
                            max={32}
                          />
                        </div>
                      </div>
                    </div>
                   </div>

                   {/* Content Grid */}
                   <div className="content-grid">
                     {/* Screenshots Section */}
                     <section className="media-section screenshots-section">
                       <div className="media-header">
                         <h3>📸 Screenshots</h3>
                         <button 
                           className="upload-btn screenshot"
                           onClick={() => fileInputRef.current?.click()}
                         >
                           📸 Ekle
                         </button>
                       </div>
                       
                       <input
                         ref={fileInputRef}
                         type="file"
                         accept="image/*"
                         multiple
                         onChange={handleScreenshotUpload}
                         style={{ display: 'none' }}
                       />

                       <div className="media-gallery horizontal-scroll">
                         {screenshots.length === 0 ? (
                           <div className="empty-state">
                             <div className="empty-icon">📸</div>
                             <p>Henüz screenshot yok</p>
                             <span>İlk screenshot'ınızı ekleyin!</span>
                           </div>
                         ) : (
                           screenshots.map(screenshot => (
                             <div key={screenshot.id} className="media-item screenshot">
                               <img src={screenshot.url} alt="Screenshot" />
                               <div className="media-info">
                                 <span>{screenshot.timestamp}</span>
                               </div>
                             </div>
                           ))
                         )}
                       </div>
                     </section>

                     {/* Video Clips Section */}
                     <section className="media-section video-clips-section">
                       <div className="media-header">
                         <h3>🎬 Video Clips</h3>
                         <button 
                           className="upload-btn video"
                           onClick={() => videoInputRef.current?.click()}
                         >
                           🎬 Ekle
                         </button>
                       </div>
                       
                       <input
                         ref={videoInputRef}
                         type="file"
                         accept="video/*"
                         multiple
                         onChange={handleVideoUpload}
                         style={{ display: 'none' }}
                       />

                       <div className="media-gallery horizontal-scroll">
                         {videos.length === 0 ? (
                           <div className="empty-state">
                             <div className="empty-icon">🎬</div>
                             <p>Henüz video yok</p>
                             <span>İlk video klibinizi ekleyin!</span>
                           </div>
                         ) : (
                           videos.map(video => (
                             <div key={video.id} className="media-item video">
                               <video src={video.url} controls />
                               <div className="media-info">
                                 <span>{video.timestamp}</span>
                                 <span>{video.size}</span>
                               </div>
                             </div>
                           ))
                         )}
                       </div>
                     </section>
                   </div>
                 </div>
               </section>
             </div>
           )}
          
          {/* History View */}
          {viewMode === 'history' && (
            <div className="history-view">
              <div className="history-header">
                <h2>📊 Session History</h2>
              </div>

              {/* Time Period Selector */}
              <div className="time-period-selector">
                {['1 Hafta', '1 Ay', '6 Ay', '1 Sene', 'All Time'].map((period) => (
                  <button 
                    key={period}
                    className={`time-period-btn ${selectedTimePeriod === period ? 'active' : ''}`}
                    onClick={() => setSelectedTimePeriod(period)}
                  >
                    {period}
                  </button>
                ))}
              </div>

              {/* Statistics Cards */}
              <div className="history-stats-grid">
                <div className="history-stat-card">
                  <div className="stat-icon">🎮</div>
                  <div className="stat-content">
                    <div className="stat-value">47</div>
                    <div className="stat-label">Total Sessions</div>
                  </div>
                </div>
                
                <div className="history-stat-card">
                  <div className="stat-icon">⏱️</div>
                  <div className="stat-content">
                    <div className="stat-value">156h</div>
                    <div className="stat-label">Total Time</div>
                  </div>
                </div>
                
                <div className="history-stat-card">
                  <div className="stat-icon">📸</div>
                  <div className="stat-content">
                    <div className="stat-value">124</div>
                    <div className="stat-label">Screenshots</div>
                  </div>
                </div>
                
                <div className="history-stat-card">
                  <div className="stat-icon">🎬</div>
                  <div className="stat-content">
                    <div className="stat-value">37</div>
                    <div className="stat-label">Video Clips</div>
                  </div>
                </div>
                
                <div className="history-stat-card">
                  <div className="stat-icon">🏆</div>
                  <div className="stat-content">
                    <div className="stat-value">Cyberpunk 2077</div>
                    <div className="stat-label">Most Played</div>
                  </div>
                </div>
              </div>



              {/* 🎯 ACCORDION STYLE FİLTRE KARTI */}
              <div className="accordion-filter-container">
                {/* Filtre Kartı Header - Her Zaman Görünür */}
                <div className="accordion-filter-header" onClick={toggleFilterAccordion}>
                  <div className="filter-header-left">
                    <div className="filter-icon">🔍</div>
                    <span className="filter-title">Filtreler & Sıralama</span>
                    {/* Aktif Filtre Sayısı Badge */}
                    {activeFiltersCount > 0 && (
                      <div className="active-filters-badge">
                        {activeFiltersCount}
                      </div>
                    )}
                  </div>
                  <div className="filter-header-right">
                    {/* Hızlı Sıralama - Header'da */}
                    <select 
                      className="quick-sort-select"
                      value={`${sortBy}-${sortOrder}`}
                      onChange={(e) => {
                        const [field, order] = e.target.value.split('-');
                        setSortBy(field);
                        setSortOrder(order);
                      }}
                      onClick={(e) => e.stopPropagation()}
                    >
                      <option value="date-desc">📅 Yeni → Eski</option>
                      <option value="date-asc">📅 Eski → Yeni</option>
                      <option value="game-asc">🎮 A → Z</option>
                      <option value="game-desc">🎮 Z → A</option>
                      <option value="platform-asc">🎯 A → Z</option>
                      <option value="platform-desc">🎯 Z → A</option>
                      <option value="duration-desc">⏱️ Uzun → Kısa</option>
                      <option value="duration-asc">⏱️ Kısa → Uzun</option>
                    </select>
                    <div className={`accordion-arrow ${isFilterExpanded ? 'expanded' : ''}`}>
                      ▼
                    </div>
                  </div>
                </div>

                {/* Genişleyen İçerik - Accordion Body */}
                <div className={`accordion-filter-body ${isFilterExpanded ? 'expanded' : ''}`}>
                  <div className="accordion-content">
                    
                    {/* Hızlı Filtre Pill'leri */}
                    <div className="quick-filters-section">
                      <div className="section-title">⚡ Hızlı Filtreler</div>
                      <div className="quick-filter-pills">
                        <button 
                          className={`filter-pill ${activeQuickFilters.includes('today') ? 'active' : ''}`}
                          onClick={() => handleQuickFilterToggle('today')}
                        >
                          📅 Bugün
                        </button>
                        <button 
                          className={`filter-pill ${activeQuickFilters.includes('week') ? 'active' : ''}`}
                          onClick={() => handleQuickFilterToggle('week')}
                        >
                          📅 Bu Hafta
                        </button>
                        <button 
                          className={`filter-pill ${activeQuickFilters.includes('hasMedia') ? 'active' : ''}`}
                          onClick={() => handleQuickFilterToggle('hasMedia')}
                        >
                          📱 Medya Var
                        </button>
                        <button 
                          className={`filter-pill ${activeQuickFilters.includes('longSession') ? 'active' : ''}`}
                          onClick={() => handleQuickFilterToggle('longSession')}
                        >
                          ⏱️ Uzun Oturum
                        </button>
                        <button 
                          className={`filter-pill ${activeQuickFilters.includes('highRating') ? 'active' : ''}`}
                          onClick={() => handleQuickFilterToggle('highRating')}
                        >
                          ⭐ Yüksek Puan
                        </button>
                        <button 
                          className={`filter-pill ${activeQuickFilters.includes('recent') ? 'active' : ''}`}
                          onClick={() => handleQuickFilterToggle('recent')}
                        >
                          🔥 Son Oynanan
                        </button>
                      </div>
                    </div>

                    {/* Detaylı Filtreler - 2 Sütun Kompakt */}
                    <div className="detailed-filters-section">
                      <div className="section-title">🎯 Detaylı Filtreler</div>
                      <div className="filter-grid-compact">
                        
                        <div className="filter-group">
                          <label>🎮 Oyun</label>
                          <select 
                            value={filters.game}
                            onChange={(e) => handleFilterChange('game', e.target.value)}
                          >
                            <option value="">Tüm Oyunlar</option>
                            <option value="cyberpunk">Cyberpunk 2077</option>
                            <option value="witcher">The Witcher 3</option>
                            <option value="rdr2">Red Dead Redemption 2</option>
                            <option value="elden">Elden Ring</option>
                          </select>
                        </div>

                        <div className="filter-group">
                          <label>🎯 Platform</label>
                          <select 
                            value={filters.platform}
                            onChange={(e) => handleFilterChange('platform', e.target.value)}
                          >
                            <option value="">Tüm Platformlar</option>
                            <option value="pc">PC</option>
                            <option value="ps5">PlayStation 5</option>
                            <option value="xbox">Xbox Series X</option>
                          </select>
                        </div>

                        <div className="filter-group">
                          <label>📅 Tarih Aralığı</label>
                          <select 
                            value={filters.dateRange}
                            onChange={(e) => handleFilterChange('dateRange', e.target.value)}
                          >
                            <option value="">Tüm Zamanlar</option>
                            <option value="today">Bugün</option>
                            <option value="week">Bu Hafta</option>
                            <option value="month">Bu Ay</option>
                            <option value="year">Bu Yıl</option>
                          </select>
                        </div>

                        <div className="filter-group">
                          <label>⏱️ Oturum Süresi</label>
                          <select 
                            value={filters.duration}
                            onChange={(e) => handleFilterChange('duration', e.target.value)}
                          >
                            <option value="">Tüm Süreler</option>
                            <option value="short">Kısa (&lt; 1 saat)</option>
                            <option value="medium">Orta (1-3 saat)</option>
                            <option value="long">Uzun (&gt; 3 saat)</option>
                          </select>
                        </div>

                        <div className="filter-group">
                          <label>📱 Medya Durumu</label>
                          <select 
                            value={filters.hasMedia}
                            onChange={(e) => handleFilterChange('hasMedia', e.target.value)}
                          >
                            <option value="">Tümü</option>
                            <option value="yes">Medya Var</option>
                            <option value="no">Medya Yok</option>
                          </select>
                        </div>

                        {/* Boş alan - Grid dengelemesi için */}
                        <div className="filter-group-spacer"></div>

                      </div>
                    </div>

                    {/* Aksiyon Butonları */}
                    <div className="accordion-actions">
                      <button 
                        className="action-btn clear-btn"
                        onClick={clearAllFilters}
                      >
                        <span className="btn-icon">🗑️</span>
                        Temizle
                      </button>
                      <button 
                        className="action-btn apply-btn"
                        onClick={applyAccordionFilters}
                      >
                        <span className="btn-icon">✅</span>
                        Uygula
                      </button>
                    </div>

                  </div>
                </div>
              </div>

              {/* Session List */}
              <div className="session-list">
                {/* Table Headers */}
                <div className="session-list-header">
                  <div className="header-game" onClick={() => handleSort('game')}>
                    Oyun İsmi {getSortIcon('game')}
                  </div>
                  <div className="header-platform" onClick={() => handleSort('platform')}>
                    Platform {getSortIcon('platform')}
                  </div>
                  <div className="header-date" onClick={() => handleSort('date')}>
                    Tarih {getSortIcon('date')}
                  </div>
                  <div className="header-duration" onClick={() => handleSort('duration')}>
                    Süre {getSortIcon('duration')}
                  </div>
                  <div className="header-media" onClick={() => handleSort('media')}>
                    Medya {getSortIcon('media')}
                  </div>
                  <div className="header-expand"></div>
                </div>
                
                {[
                  {
                    id: 1,
                    game: 'Cyberpunk 2077',
                    platform: 'PC',
                    date: '2024-01-15',
                    duration: '2h 45m',
                    rating: 5,
                    mood: '😍',
                    screenshots: 12,
                    videos: 3,
                    achievements: ['First Blood', 'Street Cred', 'Corpo Lifepath'],
                    notes: 'Amazing graphics and storyline! The character development is incredible and the side quests are really engaging.',
                    tags: ['RPG', 'Open World', 'Cyberpunk'],
                    startTime: '19:30',
                    endTime: '22:15'
                  },
                  {
                    id: 2,
                    game: 'The Witcher 3',
                    platform: 'PC',
                    date: '2024-01-14',
                    duration: '4h 20m',
                    rating: 4,
                    mood: '😊',
                    screenshots: 8,
                    videos: 2,
                    achievements: ['Griffin School Techniques', 'Butcher of Blaviken'],
                    notes: 'Great RPG experience, loved the quests. Combat system feels smooth and the story is captivating.',
                    tags: ['RPG', 'Fantasy', 'Open World'],
                    startTime: '14:00',
                    endTime: '18:20'
                  },
                  {
                    id: 3,
                    game: 'Red Dead Redemption 2',
                    platform: 'PC',
                    date: '2024-01-13',
                    duration: '3h 15m',
                    rating: 5,
                    mood: '😍',
                    screenshots: 15,
                    videos: 5,
                    achievements: ['Lending a Hand', 'Friends With Benefits'],
                    notes: 'Incredible open world, spent hours just exploring. The attention to detail is phenomenal.',
                    tags: ['Action', 'Western', 'Open World'],
                    startTime: '20:00',
                    endTime: '23:15'
                  },
                  {
                    id: 4,
                    game: 'Elden Ring',
                    platform: 'PC',
                    date: '2024-01-12',
                    duration: '1h 30m',
                    rating: 3,
                    mood: '😤',
                    screenshots: 3,
                    videos: 1,
                    achievements: ['Margit the Fell Omen'],
                    notes: 'Challenging boss fights, died many times. Need to level up more before continuing.',
                    tags: ['Souls-like', 'RPG', 'Dark Fantasy'],
                    startTime: '16:30',
                    endTime: '18:00'
                  }
                ].map(session => {
                  const isExpanded = expandedSessions.has(session.id);
                  
                  return (
                    <div key={session.id} className={`session-list-item ${isExpanded ? 'expanded' : ''}`}>
                      {/* Compact View */}
                      <div className="session-compact-view" onClick={() => toggleSessionExpansion(session.id)}>
                        <div className="session-game-column">
                          <div className="session-game-title">{session.game}</div>
                        </div>
                        
                        <div className="session-platform-column">
                          <div className="session-platform-badge">{session.platform}</div>
                        </div>
                        
                        <div className="session-date-column">
                          <span className="session-date">{session.date}</span>
                        </div>
                        
                        <div className="session-duration-column">
                          <span className="session-duration">{session.duration}</span>
                        </div>
                        
                        <div className="session-media-column">
                          <div className="session-media-count">
                            <span className="media-item">📸 {session.screenshots}</span>
                            <span className="media-item">🎥 {session.videos}</span>
                          </div>
                        </div>
                        
                        <div className="session-expand-indicator">
                          <span className={`expand-arrow ${isExpanded ? 'rotated' : ''}`}>▼</span>
                        </div>
                      </div>
                      
                      {/* Expanded View */}
                      {isExpanded && (
                        <div className="session-expanded-view">
                          <div className="session-detailed-info">
                            <div className="session-time-info">
                              <div className="time-detail">
                                <span className="time-label">Start Time:</span>
                                <span className="time-value">{session.startTime}</span>
                              </div>
                              <div className="time-detail">
                                <span className="time-label">End Time:</span>
                                <span className="time-value">{session.endTime}</span>
                              </div>
                            </div>
                            
                            <div className="session-media-stats">
                              <div className="media-stat">
                                <span className="media-icon">📸</span>
                                <span className="media-count">{session.screenshots} Screenshots</span>
                              </div>
                              <div className="media-stat">
                                <span className="media-icon">🎥</span>
                                <span className="media-count">{session.videos} Videos</span>
                              </div>
                            </div>
                            
                            {session.tags && session.tags.length > 0 && (
                              <div className="session-tags">
                                <h4>🏷️ Tags:</h4>
                                <div className="tag-list">
                                  {session.tags.map((tag, index) => (
                                    <span key={index} className="tag-badge">{tag}</span>
                                  ))}
                                </div>
                              </div>
                            )}
                            
                            {session.notes && (
                              <div className="session-notes-expanded">
                                <h4>📝 Session Notes:</h4>
                                <p>{session.notes}</p>
                              </div>
                            )}
                            
                            <div className="session-actions-expanded">
                              <button className="session-action-btn primary">
                                <span>👁️</span> View Details
                              </button>
                              <button className="session-action-btn secondary">
                                <span>📤</span> Export Session
                              </button>
                              <button className="session-action-btn secondary">
                                <span>📋</span> Copy Notes
                              </button>
                              <button className="session-action-btn secondary">
                                <span>🔗</span> Share
                              </button>
                            </div>
                          </div>
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
                </>
              )}
            </div>
          )}
        </main>

        {/* Hidden Audio Element */}
        <audio ref={audioRef} loop>
          <source src="https://www.soundjay.com/misc/sounds/bell-ringing-05.wav" type="audio/wav" />
        </audio>
      </div>
    </div>
  );
}

export default Session;